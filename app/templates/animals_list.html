<!--template/animals_list-->
{% extends 'base.html' %} {% block title %}Animales · Patitas QR{% endblock %}
{% block content %}
<section class="list-page">
  <header class="list-header">
    <h2 class="list-title">Animales</h2>
    <a class="btn btn-primary" href="{{ url_for('animales.nuevo_animal') }}"
      >+ Nuevo animal</a
    >
  </header>

  <form
    method="get"
    action="{{ url_for('animales.lista_animales') }}"
    class="toolbar"
  >
    <div class="searchbar">
      <label for="q" class="sr-only">Buscar</label>
      <input
        id="q"
        name="q"
        placeholder="Buscar por nombre, especie o color"
        value="{{ q or '' }}"
        autocomplete="off"
      />
    </div>
    <div class="toolbar-actions">
      <button
        type="submit"
        class="btn btn-primary btn-eq"
        style="margin-bottom: 10px"
      >
        Buscar
      </button>
      <a
        class="btn btn-outline btn-eq"
        href="{{ url_for('animales.lista_animales') }}"
        >Limpiar</a
      >
    </div>
  </form>

  {% if animales|length == 0 %}
  <div class="empty-state">
    <p>No hay animales que coincidan con tu búsqueda.</p>
    <a class="btn btn-outline" href="{{ url_for('animales.lista_animales') }}"
      >Ver todos</a
    >
  </div>
  {% else %}
  <div class="table-wrap">
    <table class="table table--list table-clickable">
      <thead>
        <tr>
          <th class="id-column">ID</th>
          <th>Nombre</th>
          <th>Especie</th>
          <th>Sexo</th>
          <th>Último tratamiento</th>
          <th>Estado</th>
          <th style="width: 120px">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for a in animales %} {% set ultimo = ultimos.get(a.animal_id) %} {%
        set status = ultimo.estado if ultimo else None %} {% set status_cls =
        'pill-slate' %} {% if status == 'Pendiente' %}{% set status_cls =
        'pill-amber' %}{% endif %} {% if status in ['Aprobado','Completado']
        %}{% set status_cls = 'pill-green' %}{% endif %} {% if status ==
        'Rechazado' %}{% set status_cls = 'pill-red' %}{% endif %} {% set href =
        url_for('animales.detalle_animal', animal_id=a.animal_id) %}
        <tr
          class="row-link"
          data-href="{{ href }}"
          title="Ver ficha del animal"
        >
          <td>#{{ a.animal_id }}</td>
          <td>
            <a class="row-anchor" href="{{ href }}">{{ a.nombre or '—' }}</a>
          </td>
          <td><span class="badge">{{ a.especie }}</span></td>
          <td>
            <span class="badge badge-muted">{{ a.sexo or 'Desconocido' }}</span>
          </td>
          <td>
            {% if ultimo %} {{ ultimo.fecha_tratamiento.strftime('%d-%m-%Y') if
            ultimo.fecha_tratamiento else '—' }} — {{ ultimo.tipo }} {% else %}
            <span class="muted">Sin registros</span>
            {% endif %}
          </td>
          <td>
            {% if ultimo %}
            <span class="pill {{ status_cls }}">{{ status }}</span>
            {% else %} — {% endif %}
          </td>

          <td class="actions">
            <form
              method="post"
              action="{{ url_for('animales.eliminar_animal', animal_id=a.animal_id) }}"
              class="inline-form"
              onsubmit="event.stopPropagation(); return confirm('Se eliminará este animal y sus registros (fotos, historial y tratamientos). ¿Continuar?');"
            >
              <button
                type="submit"
                class="btn btn-outline btn-sm btn-danger"
                onclick="event.stopPropagation();"
              >
                Eliminar
              </button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</section>
{% endblock %}
