<!-- app/templates/change_password.html -->
{% extends 'base.html' %} {% block title %}Cambiar contraseña · Patitas QR{%
endblock %} {% block content %}
<section class="form-page">
  <header class="list-header">
    <h2 class="list-title">Cambiar contraseña</h2>
    <a class="btn btn-outline btn-sm" href="javascript:history.back()"
      >← Volver</a
    >
  </header>

  <div class="card form-narrow">
    <form
      id="pw-form"
      method="post"
      action="{{ url_for('passwords.cambiar_password_post') }}"
      class="form-grid"
    >
      <div class="field">
        <label for="actual">Contraseña actual</label>
        <div class="password-field">
          <input
            id="actual"
            type="password"
            name="actual"
            required
            autocomplete="current-password"
          />
          <button
            type="button"
            class="pw-toggle"
            aria-label="Mostrar u ocultar contraseña"
          >
            👁️
          </button>
        </div>
      </div>

      <div class="field">
        <label for="nueva">Nueva contraseña</label>
        <div class="password-field">
          <input
            id="nueva"
            type="password"
            name="nueva"
            required
            minlength="8"
            autocomplete="new-password"
          />
          <button
            type="button"
            class="pw-toggle"
            aria-label="Mostrar u ocultar contraseña"
          >
            👁️
          </button>
        </div>
        <small class="muted">Mínimo 8 caracteres.</small>
      </div>

      <div class="field">
        <label for="repetir">Repetir nueva contraseña</label>
        <div class="password-field">
          <input
            id="repetir"
            type="password"
            name="repetir"
            required
            autocomplete="new-password"
          />
          <button
            type="button"
            class="pw-toggle"
            aria-label="Mostrar u ocultar contraseña"
          >
            👁️
          </button>
        </div>
      </div>

      <p
        id="pw-msg"
        class="muted"
        style="display: none; color: #ef4444; margin: 0"
      >
        Las contraseñas no coinciden o no cumplen el mínimo.
      </p>

      <div class="form-actions">
        <a class="btn btn-outline" href="javascript:history.back()">Cancelar</a>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</section>
{% endblock %} {% block extra_js %}
<script>
  (() => {
    // Toggle mostrar/ocultar para cada campo de contraseña
    document.querySelectorAll(".password-field").forEach((wrap) => {
      const input = wrap.querySelector(
        'input[type="password"], input[type="text"]'
      );
      const btn = wrap.querySelector(".pw-toggle");
      if (!input || !btn) return;

      const apply = (show) => {
        input.type = show ? "text" : "password";
        btn.textContent = show ? "🙈" : "👁️";
        btn.setAttribute("aria-pressed", show);
      };
      let visible = false;
      apply(visible);
      btn.addEventListener("click", () => {
        visible = !visible;
        apply(visible);
      });
    });

    // Validación simple: mínimo y coincidencia
    const form = document.getElementById("pw-form");
    const nueva = document.getElementById("nueva");
    const repetir = document.getElementById("repetir");
    const msg = document.getElementById("pw-msg");

    const check = () => {
      const a = (nueva.value || "").trim();
      const b = (repetir.value || "").trim();
      const okLen = a.length >= 8;
      const okMatch = a === b;
      msg.style.display = okLen && okMatch ? "none" : "block";
      repetir.setCustomValidity(
        okLen && okMatch ? "" : "Las contraseñas no coinciden o son muy cortas."
      );
      return okLen && okMatch;
    };

    nueva.addEventListener("input", check);
    repetir.addEventListener("input", check);
    form.addEventListener("submit", (e) => {
      if (!check()) e.preventDefault();
    });
  })();
</script>
{% endblock %}
