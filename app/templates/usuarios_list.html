{% extends 'base.html' %}
{% block title %}Usuarios · Patitas QR{% endblock %}

{% block content %}
<section class="list-page">
  <header class="list-header">
    <h2 class="list-title">Usuarios</h2>
    {% if current_user.rol == 'admin' or current_user.rol == 'veterinario' %}
      <a class="btn btn-primary" href="{{ url_for('users.usuarios_nuevo') }}">+ Nuevo</a>
    {% endif %}
  </header>

  <form method="get"
        action="{{ url_for('users.usuarios_list') }}"
        class="toolbar">
    <div class="searchbar">
      <label for="q" class="sr-only">Buscar</label>
      <input id="q" name="q" placeholder="Buscar por nombre, apellido o correo" value="{{ q or '' }}" autocomplete="off" />
    </div>
    <div class="toolbar-actions">
      <button type="submit" class="btn btn-primary btn-eq" style="margin-bottom: 10px;">Buscar</button>
      <a class="btn btn-outline btn-eq" href="{{ url_for('users.usuarios_list') }}">Limpiar</a>
    </div>
  </form>

  {% if usuarios|length == 0 %}
    <div class="empty-state">
      <p>No hay usuarios que coincidan con tu búsqueda.</p>
      {% if current_user.rol == 'admin' %}
        <a class="btn btn-outline" href="{{ url_for('users.usuarios_nuevo') }}">Crear usuario</a>
      {% endif %}
    </div>
  {% else %}
    <div class="table-wrap">
      <table class="table table--list">
        <thead>
          <tr>
            <th class="id-column">ID</th>
            <th>Nombre</th>
            <th>Correo</th>
            <th style="width:100px">Rol</th>
            <th style="width:80px">Estado</th>
            <th style="width:100px" class="hide-sm">Creado</th>
            <th style="width:180px">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for u in usuarios %}
          <tr>
            <td>#{{ u.usuario_id }}</td>

            <td>{{ u.nombre }} {{ u.apellido }}</td>

            <td>
              <a class="link-row" href="mailto:{{ u.correo }}">{{ u.correo }}</a>
            </td>

            <td>
              {% if current_user.rol == 'admin' %}
                <form method="post"
                      action="{{ url_for('users.usuario_cambiar_rol', usuario_id=u.usuario_id) }}"
                      class="inline-form">
                  <label for="rol_{{ u.usuario_id }}" class="sr-only">Rol</label>
                  <select id="rol_{{ u.usuario_id }}" name="rol" onchange="this.form.submit()">
                    <option value="admin"       {{ 'selected' if u.rol=='admin' else '' }}>admin</option>
                    <option value="veterinario" {{ 'selected' if u.rol=='veterinario' else '' }}>veterinario</option>
                    <option value="asistente"   {{ 'selected' if u.rol=='asistente' else '' }}>asistente</option>
                  </select>
                </form>
              {% else %}
                <span class="badge">{{ u.rol }}</span>
              {% endif %}
            </td>

            <td>
              {% if u.activo %}
                <span class="badge badge-green">Activo</span>
              {% else %}
                <span class="badge pill-red">Inactivo</span>
              {% endif %}
            </td>

            <td class="hide-sm">
              {{ u.creado_en.strftime('%d-%m-%Y') if u.creado_en else '—' }}
            </td>

            <td class="actions">
              {% if current_user.rol == 'admin' %}
                {% if u.activo %}
                  <form method="post"
                        action="{{ url_for('users.usuario_desactivar', usuario_id=u.usuario_id) }}"
                        class="inline-form">
                    <button type="submit" class="btn btn-outline btn-sm btn-eq"
                            onclick="return confirm('¿Desactivar este usuario?')">
                      Desactivar
                    </button>
                  </form>
                {% else %}
                  <form method="post"
                        action="{{ url_for('users.usuario_activar', usuario_id=u.usuario_id) }}"
                        class="inline-form">
                    <button type="submit" class="btn btn-primary btn-sm btn-eq">Activar</button>
                  </form>
                {% endif %}

                {% if u.usuario_id != current_user.usuario_id %}
                  <form method="post"
                        action="{{ url_for('users.usuario_eliminar', usuario_id=u.usuario_id) }}"
                        class="inline-form">
                    <button type="submit" class="btn btn-outline btn-sm btn-danger"
                            onclick="return confirm('¿Estas seguro de eliminar este usuario?')">
                      Eliminar
                    </button>
                  </form>
                {% endif %}
              {% else %}
                —
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
</section>
{% endblock %}
